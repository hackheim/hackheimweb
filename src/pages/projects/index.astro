---
import { getCollection } from "astro:content";
import { getImage } from "astro:assets";
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/landing/Header.astro";
import Footer from "../../components/landing/Footer.astro";
import Icon from "../../components/ui/Icon.astro";
import Button from "../../components/ui/Button.astro";
import ProjectGrid from "../../components/svelte/ProjectGrid.svelte";

const projects = await getCollection("projects", ({ data }) => {
    return data.published !== false;
}).then((projects) =>
    projects.sort((a, b) => b.data.date.getTime() - a.data.date.getTime()),
);

// Process images with Astro optimization
const projectsWithOptimizedImages = await Promise.all(
    projects.map(async (project) => {
        let optimizedCoverImage = null;

        if (project.data.coverImage) {
            try {
                const optimized = await getImage({
                    src: project.data.coverImage,
                    width: 600,
                    height: 400,
                    format: "webp",
                    quality: 80,
                    fit: "cover",
                });
                optimizedCoverImage = optimized.src;
            } catch (e) {
                // Fallback to original if optimization fails
                optimizedCoverImage = project.data.coverImage;
            }
        }

        return {
            ...project,
            data: {
                ...project.data,
                coverImage: optimizedCoverImage,
            },
        };
    }),
);

// Get unique tags for filtering
const allTags = [...new Set(projects.flatMap((p) => p.data.tags))].sort();
---

<Layout>
    <div class="min-h-screen bg-background">
        <Header />

        <!-- Header -->
        <div class="py-16 px-4">
            <div class="container mx-auto max-w-6xl text-center">
                <Button href="/" variant="ghost" class="mb-6">
                    <Icon name="ArrowLeft" class="w-4 h-4 mr-2" />
                    Tilbake til hovedside
                </Button>

                <h1
                    class="text-4xl font-bold mb-4 text-foreground"
                    style="font-family: 'Space Grotesk', sans-serif;"
                >
                    Prosjektgalleri
                </h1>
                <p class="text-xl text-muted-foreground max-w-2xl mx-auto">
                    Utforsk kreative prosjekter laget av medlemmene våre. Fra
                    3D-printing til elektronikk – la deg inspirere!
                </p>
            </div>
        </div>

        <div class="container mx-auto px-4 py-8 max-w-6xl">
            <!-- Interactive Project Grid with Svelte -->
            <ProjectGrid
                projects={projectsWithOptimizedImages}
                allTags={allTags}
                client:load
            />

            <!-- CTA Section -->
            <div
                class="mt-16 text-center bg-background/60 backdrop-blur-sm border border-border/50 rounded-xl p-10"
            >
                <Icon
                    name="Lightbulb"
                    class="w-12 h-12 mx-auto mb-4 text-accent"
                />
                <h3 class="text-2xl font-bold mb-4 text-foreground">
                    Har du et prosjekt å dele?
                </h3>
                <p class="text-muted-foreground mb-8 max-w-2xl mx-auto">
                    Vi elsker å vise frem medlemmenes kreative arbeid! Bli med i
                    fellesskapet og del dine egne prosjekter.
                </p>
                <div class="flex flex-wrap justify-center gap-4">
                    <Button href="/wiki/welcome/join" variant="primary">
                        <Icon name="Users" class="w-4 h-4 mr-2" />
                        Bli medlem
                    </Button>
                    <Button href="/wiki/welcome/contact" variant="outline">
                        <Icon name="Mail" class="w-4 h-4 mr-2" />
                        Kontakt oss
                    </Button>
                </div>
            </div>
        </div>

        <Footer />
    </div>
</Layout>
